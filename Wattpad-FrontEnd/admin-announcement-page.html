<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wattpad Admin - Announcements</title>
    <link rel="icon" type="image/ico" href="assets/image/wattpad-icon-2-removebg-preview.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="assets/style/admin-announcement-page-style.css">
</head>
<body style="display: none; visibility: hidden; opacity: 0;">
<div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar">
        <img class="logo" src="assets/image/wattpad-logo.svg" alt="Wattpad Logo" onclick="navigateToDashboard()">
        <ul>
            <li><a href="admin-dashboard-page.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="admin-admin-page.html"><i class="fas fa-users"></i> Manage Admins</a></li>
            <li><a href="admin-user-page.html"><i class="fas fa-users-cog"></i> Manage Users</a></li>
            <li><a href="admin-story-page.html"><i class="fas fa-book"></i> Manage Stories</a></li>
            <li><a href="admin-transaction-page.html"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
            <li><a href="admin-announcement-page.html"><i class="fas fa-bullhorn"></i> Announcements</a></li>
            <li><a href="admin-genre-page.html"><i class="fas fa-tags"></i> Genres</a></li>
            <li><a href="#"><i class="fas fa-flag"></i> Reports</a></li>
            <li id="logout"><a href="#"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">

        <!-- Modal -->
        <div id="announcementModal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h2>Announcement (New)</h2>
                <input type="text" id="modalTitle" placeholder="Title" required>
                <textarea id="modalDescription" placeholder="Description" required></textarea>
                <select id="modalUserType" onchange="toggleUserId()">
                    <option value="all">All Users</option>
                    <option value="verified">Verified Users</option>
                    <option value="specific">Specific User</option>
                </select>
                <input type="text" id="modalUserId" placeholder="User Id" disabled>
                <button id="sendBtn" onclick="sendAnnouncement()">Send</button>
            </div>
        </div>

        <div class="breadcrumb">
            <a href="admin-dashboard.html">Dashboard</a> > Announcements
        </div>
        <h1 class="page-title">Announcements</h1>

        <div class="controls">
            <input type="date" class="date-input" id="dateFilter" onchange="filterAnnouncements()">
            <select class="user-type-select" id="userTypeFilter" onchange="filterAnnouncements()">
                <option value="all">All Users</option>
                <option value="verified">Verified Users</option>
                <option value="specific">Specific User</option>
            </select>
            <input style="width: 250px;" type="text" class="user-id-input" id="userIdInput" placeholder="Enter User ID">
            <button id="createAnnouncementBtn" class="create-btn"><i  style="font-size: 13px; color: #222222; margin-right: 5px;" class="fa-solid fa-plus"></i>New</button>
        </div>

        <div class="announcement-container" id="announcementContainer">
            <!-- Announcements will be loaded here -->
            <div class="loading">
                <div class="loading-spinner"></div>
                Loading announcements...
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
            <div class="pagination-info" id="paginationInfo">
                Showing 1-10 of 156 transactions
            </div>
            <div class="pagination-controls">
                <button class="pagination-btn" id="prevBtn" onclick="previousPage()">Previous</button>
                <div class="page-numbers" id="pageNumbers">
                    <!-- Page numbers will be generated dynamically -->
                </div>
                <button class="pagination-btn" id="nextBtn" onclick="nextPage()">Next</button>
            </div>
        </div>
    </main>
</div>

<script>

    //check user register or not
    window.onload = function () {

        fetch('http://localhost:8080/api/v1/announcement/admin', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(JSON.stringify(errData));
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);

                document.body.style.display = 'block';
                document.body.style.visibility = 'visible';
                document.body.style.opacity = 1;

            })
            .catch(error => {
                let response = JSON.parse(error.message);
                console.log(response);

                window.location.href = 'http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-login-page.html';
            });
    }


    let currentPage = 1;
    let sort = {
        'date': null,
        'type': 'all',
    };

    let start = 0;
    let end = 0;
    let total = 0;

    function displayAnnouncements() {

        const announcementContainer = document.getElementById('announcementContainer');
        announcementContainer.innerHTML = '';

        fetch('http://localhost:8080/api/v1/announcement/admin/loadAnnouncement/' + currentPage, {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(sort)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(JSON.stringify(errData));
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Load Success:', data);

                total = data.data.totalAnnouncements;
                start = data.data.start;
                end = data.data.end;

                paginationTextSet();

                if (data.data.adminAnnouncementDTOList.length === 0) {
                    announcementContainer.innerHTML = '<div class="loading"><div style="font-size: 48px; margin-bottom: 15px;">ðŸ“­</div>No announcements found</div>';
                }
                else {
                    data.data.adminAnnouncementDTOList.forEach(announcement => {
                        const div = document.createElement('div');
                        div.classList.add('announcement');
                        div.innerHTML = `
                        <div class="content">
                            <h3>${announcement.title}</h3>
                            <p>${announcement.description}</p>
                            <p style="font-size: 13.5px; color: #6f6f6f; margin-bottom: 0; padding-bottom: 0;" class="date-send">${new Date(announcement.dateTime).toLocaleString()}</p>
                            <p style="font-size: 13.5px; color: #ff6122;" class="sent-to">Sent to: ${announcement.sentTo === 'specific' ? `${announcement.sentTo} (User ID: ${announcement.userId})` : announcement.sentTo}</p>
                        </div>
                        <div class="details delete-btn" data-announcement-id="${announcement.id}">
                            <svg class="trash-can" width="23" height="23" viewBox="0 0 24 24" fill="#222" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 7V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V7H6ZM8 9H16V20H8V9ZM15.5 4L14.5 3H9.5L8.5 4H5V6H19V4H15.5Z"/>
                            </svg>
                        </div>
                    `;
                        announcementContainer.appendChild(div);
                    });
                }

            })
            .catch(error => {
                console.error('Load Error:', error);

            });
    }


    function paginationTextSet() {
        document.getElementById('paginationInfo').textContent = `Showing ${start}-${end} of ${total} announcements`;

        if(start>1){
            document.getElementById("prevBtn").disabled = false;
        }
        else{
            document.getElementById("prevBtn").disabled = true;
        }

        if(end<total){
            document.getElementById("nextBtn").disabled = false;
        }
        else{
            document.getElementById("nextBtn").disabled = true;
        }
    }


    function previousPage() {
        currentPage--;
        displayAnnouncements();

    }


    function nextPage() {
        currentPage++;
        displayAnnouncements();

    }


    const userTypeFilter = document.getElementById('userTypeFilter');
    userTypeFilter.addEventListener('change', function () {
        sort.type = this.value;
        displayAnnouncements();
    });


    const dateInput = document.getElementById('dateFilter');
    dateInput.addEventListener('input', function(event) {
        const selectedDate = event.target.value;
        if (selectedDate) {
            console.log('User selected date:', selectedDate);
            sort.date = selectedDate;
        } else {
            console.log('Date cleared / no date selected');
            sort.date = null;
        }
        displayAnnouncements();
    });


    const userIdInput = document.getElementById('userIdInput');
    userIdInput.addEventListener('keyup', function(event) {

        if(event.target.value.trim()===''){
            displayAnnouncements();
        }

        if (event.key === 'Enter') {
            const userId = event.target.value.trim();

            const isValid = /^[0-9]+$/.test(userId);

            if (!isValid) {
                // alert('Invalid User ID! Only numbers are allowed.');
                return;
            }

            fetch('http://localhost:8080/api/v1/announcement/admin/searchByUserId/'+userId, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(JSON.stringify(errData));
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Success:', data);

                    if (data.data.length === 0) {
                        announcementContainer.innerHTML = `<div class="loading"><div style="font-size: 48px; margin-bottom: 15px;">ðŸ“­</div>No announcements found for user id: ${userId}</div>`;
                    }
                    else {
                        const announcementContainer = document.getElementById('announcementContainer');
                        announcementContainer.innerHTML = '';

                        data.data.forEach(announcement => {
                            const div = document.createElement('div');
                            div.classList.add('announcement');
                            div.innerHTML = `
                        <div class="content">
                            <h3>${announcement.title}</h3>
                            <p>${announcement.description}</p>
                            <p style="font-size: 13.5px; color: #6f6f6f; margin-bottom: 0; padding-bottom: 0;" class="date-send">${new Date(announcement.dateTime).toLocaleString()}</p>
                            <p style="font-size: 13.5px; color: #ff6122;" class="sent-to">Sent to: ${announcement.sentTo === 'specific' ? `${announcement.sentTo} (User ID: ${announcement.userId})` : announcement.sentTo}</p>
                        </div>
                        <div class="details delete-btn" data-announcement-id="${announcement.id}">
                            <svg class="trash-can" width="23" height="23" viewBox="0 0 24 24" fill="#222" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 7V20C6 21.1 6.9 22 8 22H16C17.1 22 18 21.1 18 20V7H6ZM8 9H16V20H8V9ZM15.5 4L14.5 3H9.5L8.5 4H5V6H19V4H15.5Z"/>
                            </svg>
                        </div>
                    `;
                            announcementContainer.appendChild(div);
                        });
                    }
                })
                .catch(error => {
                    let response = JSON.parse(error.message);
                    console.log(response);
                });
        }
    });


    document.addEventListener('click', function(event) {

        const btn = event.target.closest('.delete-btn');
        if (!btn) return;

        const announcementId = btn.getAttribute('data-announcement-id');

        Swal.fire({
            title: 'Are you sure?',
            text: 'Delete this announcement? Once deleted, users will no longer see it.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete',
            cancelButtonText: 'Cancel',
            customClass: {
                popup: 'modern-swal',
                confirmButton: 'swal2-confirm',
                cancelButton: 'swal2-cancel'
            }
        }).then((result) => {
            if (result.isConfirmed) {

                fetch('http://localhost:8080/api/v1/announcement/admin/delete/'+announcementId, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(JSON.stringify(errData));
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Success:', data);

                        displayAnnouncements();
                        Swal.fire({
                            title: 'Success',
                            text: 'Announcement has been deleted!',
                            customClass: {
                                popup: 'modern-swal-wide-short',
                                title: 'swal-title',
                                htmlContainer: 'swal-text'
                            },
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });

                    })
                    .catch(error => {
                        let response = JSON.parse(error.message);
                        console.log(response);

                        Swal.fire({
                            title: 'Fail',
                            text: 'Failed to delete the announcement. Please try again later!',
                            customClass: {
                                popup: 'modern-swal-wide-short',
                                title: 'swal-title',
                                htmlContainer: 'swal-text'
                            },
                            timer: 3000,
                            timerProgressBar: true,
                            showConfirmButton: false
                        });
                    });
            }
            else {
                // console.log('still activate');
            }
        });
    });


    function navigateToDashboard() {
        window.location.href = 'http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-dashboard-page.html';
    }


    document.addEventListener('DOMContentLoaded', () => {
        displayAnnouncements();

    });


    document.getElementById('createAnnouncementBtn').addEventListener('click', function() {
        document.getElementById('announcementModal').style.display = 'flex';
    });


    document.querySelector('.close-btn').addEventListener('click', function() {
        document.getElementById('announcementModal').style.display = 'none';
    });


    function toggleUserId() {
        const selectEl = document.getElementById('modalUserType');
        const userIdInput = document.getElementById('modalUserId');

        const value = selectEl.value;

        if (value === 'specific') {
            userIdInput.disabled = false;
        } else {
            userIdInput.disabled = true;
            userIdInput.value = '';
        }
    }


    function sendAnnouncement() {

        const title = document.getElementById('modalTitle').value.trim();
        const description = document.getElementById('modalDescription').value.trim();
        const userType = document.getElementById('modalUserType').value;
        let userId = document.getElementById('modalUserId').value.trim();

        if(userId===''){
            userId = null;
        }

        let data = {
            'title': title,
            'description': description,
            'sentTo': userType,
            'userId': userId
        }

        fetch('http://localhost:8080/api/v1/announcement/admin/add', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)

        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(JSON.stringify(errData));
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);

                displayAnnouncements();
                Swal.fire({
                    title: 'Success',
                    text: 'Announcement has been added!',
                    customClass: {
                        popup: 'modern-swal-wide-short',
                        title: 'swal-title',
                        htmlContainer: 'swal-text'
                    },
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });

            })
            .catch(error => {
                let response = JSON.parse(error.message);
                console.log(response);

                Swal.fire({
                    title: 'Fail',
                    text: 'Failed to add the announcement. Please try again later!',
                    customClass: {
                        popup: 'modern-swal-wide-short',
                        title: 'swal-title',
                        htmlContainer: 'swal-text'
                    },
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                });
            });

    }


    window.addEventListener('click', function(event) {
        const modal = document.getElementById('announcementModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    document.getElementById('logout').addEventListener('click', function (event) {
        event.preventDefault();

        fetch('http://localhost:8080/auth/admin/logout', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errData => {
                        throw new Error(JSON.stringify(errData));
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Success:', data);

                window.location.href = `http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-login-page.html`;

            })
            .catch(error => {
                let response = JSON.parse(error.message);
                console.log(response);

            });
    });

</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="lib/jquery-3.7.1.min.js"></script>
<script src="assets/js/admin-announcement-page-script.js"></script>
</body>
</html>