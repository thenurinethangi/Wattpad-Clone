<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Wattpad Admin - Manage Admins</title>
  <link rel="icon" type="image/ico" href="assets/image/wattpad-icon-2-removebg-preview.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="assets/style/admin-admin-page-style.css">
</head>
<body style="display: none; visibility: hidden; opacity: 0;">
<div class="dashboard-container">
  <!-- Sidebar -->
  <nav class="sidebar">
    <img class="logo" src="assets/image/wattpad-logo.svg" alt="Wattpad Logo" onclick="navigateToDashboard()">
    <ul>
      <li><a href="admin-dashboard-page.html"><i class="fas fa-home"></i> Dashboard</a></li>
      <li><a href="admin-admin-page.html"><i class="fas fa-users"></i> Manage Admins</a></li>
      <li><a href="admin-user-page.html"><i class="fas fa-users-cog"></i> Manage Users</a></li>
      <li><a href="admin-story-page.html"><i class="fas fa-book"></i> Manage Stories</a></li>
      <li><a href="admin-transaction-page.html"><i class="fas fa-exchange-alt"></i> Transactions</a></li>
      <li><a href="admin-announcement-page.html"><i class="fas fa-bullhorn"></i> Announcements</a></li>
      <li><a href="admin-genre-page.html"><i class="fas fa-tags"></i> Genres</a></li>
      <li><a href="#"><i class="fas fa-flag"></i> Reports</a></li>
      <li id="logout"><a href="#"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
    </ul>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <div class="breadcrumb">
      <a href="admin-dashboard.html">Dashboard</a> > Admin
    </div>
    <h1 class="page-title">Admin</h1>

    <div class="controls">
      <div class="search-bar" style="display: flex;">
        <i class="fa-solid fa-magnifying-glass" style="position: absolute; color: lightgray; margin-left: 10px; margin-top: 15px;"></i>
        <input type="text" id="searchInput" placeholder="Search">
      </div>
      <div class="sort-combo">
        <select id="statusSort">
          <option value="all">All</option>
          <option value="active">Active</option>
          <option value="deactive">Deactive</option>
        </select>
      </div>
      <i class="fa-solid fa-plus" style="position: absolute; right: 187px; color: #ffffff; font-size: 12px; padding-right: 3px;"></i>
      <button class="create-btn" onclick="navigateToCreateAdmin()">Create New Admin</button>
    </div>

    <div class="admin-list" style="background-color: #ffffff; box-shadow: 0 4px 12px rgba(255, 97, 34, 0.075);">
      <div class="admin-columns">
        <div>ID</div>
        <div>Profile Pic</div>
        <div>Full Name</div>
        <div>Username</div>
        <div>Email</div>
        <div>Pronounce</div>
        <div>Status</div>
      </div>
      <!-- Admin List -->
      <div id="adminList">
        <!-- Loading state initially -->
        <div class="loading">
          <div class="loading-spinner"></div>
          Loading administrators...
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" style="background-color: #ffffff; box-shadow: 0 4px 12px rgba(255, 97, 34, 0.075);">
      <div class="pagination-info" id="paginationInfo">
        Showing 1-10 of 156 administrators
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn" id="prevBtn" onclick="previousPage()">Previous</button>
        <div class="page-numbers" id="pageNumbers">
          <!-- Page numbers will be generated dynamically -->
        </div>
        <button class="pagination-btn" id="nextBtn" onclick="nextPage()">Next</button>
      </div>
    </div>

  </main>
</div>

<script>

  //check user register or not
  window.onload = function () {

    fetch('http://localhost:8080/api/v1/admin', {
      method: 'GET',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(errData => {
                  throw new Error(JSON.stringify(errData));
                });
              }
              return response.json();
            })
            .then(data => {
              console.log('Success:', data);

              document.body.style.display = 'block';
              document.body.style.visibility = 'visible';
              document.body.style.opacity = 1;

            })
            .catch(error => {
              let response = JSON.parse(error.message);
              console.log(response);

              window.location.href = 'http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-login-page.html';
            });
  }


  let currentPage = 1;
  let sort = {
    'status': 'all',
  };

  let start = 0;
  let end = 0;
  let total = 0;

  function displayAdmins() {

    const adminList = document.querySelector('.admin-list');
    adminList.innerHTML = '';
    adminList.appendChild(createColumns());

    fetch('http://localhost:8080/api/v1/admin/admin/loadAdmin/' + currentPage, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(sort)
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(errData => {
                  throw new Error(JSON.stringify(errData));
                });
              }
              return response.json();
            })
            .then(data => {
              console.log('Load Success:', data);

              total = data.data.totalAdmins;
              start = data.data.start;
              end = data.data.end;

              paginationTextSet();

              if (data.data.adminDTOList.length === 0) {
                adminList.innerHTML = '<div class="loading"><div style="font-size: 48px; margin-bottom: 15px;">ðŸ“­</div>No administrators found</div>';
              }
              else {
                data.data.adminDTOList.forEach(admin => {

                  const row = document.createElement('div');
                  row.classList.add('admin-row');
                  row.innerHTML = `

                <div>${admin.id || 'N/A'}</div>
                <div class="admin-profile"><img src="${admin.profilePicPath || 'https://static.vecteezy.com/system/resources/previews/005/005/788/non_2x/user-icon-in-trendy-flat-style-isolated-on-grey-background-user-symbol-for-your-web-site-design-logo-app-ui-illustration-eps10-free-vector.jpg'}" alt="${admin.fullName || 'Admin'}"></div>
                <div>${admin.fullName || 'N/A'}</div>
                <div>${admin.username || 'N/A'}</div>
                <div>${admin.email || 'N/A'}</div>
                <div>${admin.pronouns || 'N/A'}</div>
                <div class="${admin.isActive === 1 ? 'status-active' : 'status-deactive'}">${admin.isActive === 1 ? 'Active' : 'Deactive' }</div>
                <div class="action-icons">
                        <a href="#" onclick="editAdmin('${admin.id}')" title="Edit"><i class="fas fa-pen" style="color: rgba(255,97,34,0.93); margin-right: 10px; font-size: 14.5px;"></i></a>
                        ${admin.isActive === 1 ? `<a href="#" onclick="deleteAdmin('${admin.id}')" title="Delete"><i class="fas fa-trash" style="color: rgba(255,97,34,0.93); font-size: 14.5px;"></i></a>` : ``}
                </div>
            `;
                  adminList.appendChild(row);
                });
              }

            })
            .catch(error => {
              console.error('Load Error:', error);

            });
  }


  function editAdmin(adminId){

    window.location.href = 'http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-new-admin-page.html?userId='+adminId;
  }


  function deleteAdmin(adminId){

    Swal.fire({
      title: 'Are you sure?',
      text: 'Would you like to deactivate this admin?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, unpublish',
      cancelButtonText: 'Cancel',
      customClass: {
        popup: 'modern-swal',
        confirmButton: 'swal2-confirm',
        cancelButton: 'swal2-cancel'
      }
    }).then((result) => {
      if (result.isConfirmed) {

        fetch('http://localhost:8080/api/v1/admin/admin/deactivate/'+adminId, {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          },
        })
                .then(response => {
                  if (!response.ok) {
                    return response.json().then(errData => {
                      throw new Error(JSON.stringify(errData));
                    });
                  }
                  return response.json();
                })
                .then(data => {
                  console.log('Success:', data);

                  if(data.data===true){

                    displayAdmins();

                    Swal.fire({
                      title: 'Success',
                      text: 'Admin has been deactivated!',
                      customClass: {
                        popup: 'modern-swal-wide-short',
                        title: 'swal-title',
                        htmlContainer: 'swal-text'
                      },
                      timer: 3000,
                      timerProgressBar: true,
                      showConfirmButton: false
                    });
                  }
                  else {
                    Swal.fire({
                      title: 'Fail',
                      text: 'Fail to deactivate admin!',
                      customClass: {
                        popup: 'modern-swal-wide-short',
                        title: 'swal-title',
                        htmlContainer: 'swal-text'
                      },
                      timer: 3000,
                      timerProgressBar: true,
                      showConfirmButton: false
                    });
                  }

                })
                .catch(error => {
                  let response = JSON.parse(error.message);
                  console.log(response);

                  Swal.fire({
                    title: 'Fail',
                    text: 'Failed to deactivate admin. Please try again later!',
                    customClass: {
                      popup: 'modern-swal-wide-short',
                      title: 'swal-title',
                      htmlContainer: 'swal-text'
                    },
                    timer: 3000,
                    timerProgressBar: true,
                    showConfirmButton: false
                  });
                });
      }
      else {
        // console.log('still activate');
      }
    });

  }


  function createColumns() {
    const columns = document.createElement('div');
    columns.classList.add('admin-columns');
    columns.innerHTML = `
        <div>ID</div>
        <div>Profile Pic</div>
        <div>Full Name</div>
        <div>Username</div>
        <div>Email</div>
        <div>Pronounce</div>
        <div>Status</div>
        <div>Action</div>
    `;
    return columns;
  }


  function paginationTextSet() {
    document.getElementById('paginationInfo').textContent = `Showing ${start}-${end} of ${total} administrators`;

    if(start>1){
      document.getElementById("prevBtn").disabled = false;
    }
    else{
      document.getElementById("prevBtn").disabled = true;
    }

    if(end<total){
      document.getElementById("nextBtn").disabled = false;
    }
    else{
      document.getElementById("nextBtn").disabled = true;
    }
  }


  const statusFilter = document.getElementById('statusSort');
  statusFilter.addEventListener('change', function () {
    sort.status = this.value;
    displayAdmins();
  });


  function navigateToCreateAdmin() {
    window.location.href = 'http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-new-admin-page.html';
  }


  function navigateToDashboard() {
    window.location.href = 'http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-dashboard-page.html';
  }


  document.addEventListener('DOMContentLoaded', () => {
    displayAdmins();

    document.getElementById('nextBtn').addEventListener('click', () => {
        currentPage++;
        displayAdmins();
    });

    document.getElementById('prevBtn').addEventListener('click', () => {
        currentPage--;
        displayAdmins();
    });
  });


  document.getElementById('logout').addEventListener('click', function (event) {
    event.preventDefault();

    fetch('http://localhost:8080/auth/admin/logout', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json'
      },
    })
            .then(response => {
              if (!response.ok) {
                return response.json().then(errData => {
                  throw new Error(JSON.stringify(errData));
                });
              }
              return response.json();
            })
            .then(data => {
              console.log('Success:', data);

              window.location.href = `http://localhost:63342/Wattpad-Clone/Wattpad-FrontEnd/admin-login-page.html`;

            })
            .catch(error => {
              let response = JSON.parse(error.message);
              console.log(response);

            });
  });

</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="lib/jquery-3.7.1.min.js"></script>
<script src="assets/js/admin-admin-page-script.js"></script>
</body>
</html>