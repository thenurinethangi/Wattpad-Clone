<!DOCTYPE html>
<html lang="en">
<head>
  <meta charSet="utf-8"/>
  <link rel="icon" type="image/ico" href="assets/image/wattpad-icon-2-removebg-preview.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Chapter - Wattpad</title>
  <meta name="author" content="Thenuri Nethangi">
  <meta name="keywords" content="online stories, read stories, write stories, wattpad alternative, fiction platform, storytelling, novels, short stories, creative writing, user-generated stories">
  <meta name="description" content="Discover and share captivating stories on our platform. Read novels, write your own tales, and connect with a community of passionate readers and writers.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Anton+SC&family=Cinzel+Decorative:wght@400;700;900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Merriweather+Sans:ital,wght@0,300..800;1,300..800&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Raleway:ital,wght@0,100..900;1,100..900&family=Red+Hat+Display:ital,wght@0,300..900;1,300..900&family=Roboto:ital,wght@1,800&family=Rubik:ital@0;1&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/style/variables.css">
  <link rel="stylesheet" href="assets/style/create-chapter-page-style.css">
  <link rel="stylesheet" href="assets/style/footer-style.css">
  <style>
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 5px;
      vertical-align: middle;
    }

    .hidden {
      display: none;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /*.paragraph-textarea {*/
    /*  resize: none;       !* prevent manual drag *!*/
    /*  overflow: hidden;   !* hide scrollbars *!*/
    /*  min-height: 40px;   !* optional *!*/
    /*}*/

    .paragraph-textarea {
      width: 100%;
      border: none;
      outline: none;
      resize: none;          /* disable manual resize */
      overflow: hidden;      /* no scrollbars */
      background: transparent;
      /*font-family: inherit;*/
      /*font-size: inherit;*/
      line-height: 1.6;      /* matches your text paragraphs */
      padding: 0;
    }

  </style>
</head>
<body style="display: none; visibility: hidden; opacity: 0;">

<!------------------------header------------------------>
<div class="top-header">

  <!-------header left-------->
  <div class="header-left">
    <!--back btn-->
    <button class="back-btn" onclick="history.back()">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <!--story title,chapter name placed container-->
    <div class="story-info">
      <!--story cover image-->
      <div class="story-cover">
        <img src="assets/image/story-01.webp" style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
      </div>
      <!--story details-->
      <div class="story-details">
        <p id="story-title" style="color: #6f6f6f; font-size: 14px; line-height: 18px;">Story title</p>
        <h2 id="chapter-title">Untitled Part 1</h2>
        <div class="story-status">
          Draft (<span id="wordCount">0</span> Words)
          <div id="save-spinner" class="spinner hidden"></div>
          <span class="saved-indicator">Unsaved</span>
        </div>
      </div>
    </div>
  </div>

  <!-------header right-------->
  <div class="header-actions">
    <button class="btn btn-primary" type="button" onclick="publish()">Publish</button>
    <button class="btn btn-secondary" type="button" onclick="collectAndPrepareContentForForm()">Save</button>
    <button class="btn btn-outline" type="button" onclick="previewChapter()">Preview</button>
    <button class="more-btn">
      <i class="fas fa-ellipsis-h"></i>
    </button>
  </div>
</div>



<!--------------------main container--------------------->
<div class="editor-container">

  <!--chapter cover image container-->
  <div class="media-buttons" style="max-height: 340px; min-height: 120px; background-color: #eee; position: relative;">
    <!--cover image - this hidden util user select image for cover image-->
<!--    <img src="assets/image/story-01.webp" style="object-fit: contain;">-->
    <!--cover image input btn-->
    <div style="position: absolute; display: flex; top: 0; bottom: 0; justify-content: center; align-items: center; gap: 10px;">
      <button class="media-btn" onclick="insertMedia2('image')">
        <i class="fas fa-image"></i>
        Add Image
      </button>
      <button class="media-btn" onclick="insertMedia2('video')">
        <i class="fas fa-video"></i>
        Add Video
      </button>
    </div>
    <!--cover image edit btn - this only show when cover image added by user when need to remove or update-->
    <div style="background-color: rgba(0,0,0,0.87); width: 39px; height: 39px; border-radius: 100%; display: flex; justify-content: center; align-items: center; position: absolute; right: 12px; bottom: 10px;">
      <svg fill="#222222" stroke="#ffffff" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round" class="fa-4x edit-media on-show-media-menu">
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
      </svg>
    </div>
  </div>

  <!--chapter title-->
  <div class="chapter-title">
    <h1 contenteditable="true" id="chapterTitleEdit">
      Untitled Part 1
    </h1>
  </div>


  <form method="post" id="chapterForm" enctype="multipart/form-data">
    <input type="hidden" name="storyId">
    <input type="hidden" name="chapterTitle" id="chapterTitleInput">
    <input type="hidden" name="chapterContentJson" id="chapterContentJsonInput">
    <input type="hidden" name="actionType" id="actionTypeInput">

    <div class="content-editor" id="contentEditor">
      <div class="paragraph-container" id="initial_paragraph" data-paragraph-id="initial_paragraph">
        <textarea class="paragraph-textarea" id="initial_textarea" placeholder="Type your text" onkeydown="handleKeyDown(event, this)" oninput="updateWordCount()"></textarea>
        <!--here place the content-->
        <div class="add-media-popup" id="initial_popup">
          <div class="media-option" onclick="addMediaToCurrentParagraph('image')">
            <i class="fas fa-image"></i>
            <span>Add Image</span>
          </div>
          <div class="media-option" onclick="addMediaToCurrentParagraph('video')">
            <i class="fas fa-video"></i>
            <span>Add Video</span>
          </div>
          <div class="media-option" onclick="hideMediaPopup()">
            <i class="fas fa-times"></i>
            <span>Continue Writing</span>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<!--this file input need when click on add image this ill open. so don't remove-->
<input type="file" id="masterImageInput" class="hidden-file-input" accept="image/*" onchange="handleMasterImageSelection(event)">

<!--words count-->
<div class="word-count">
  <span id="wordCountDisplay">0 words</span>
</div>



<!-- --------------------------footer---------------------------- -->
<footer class="KsomK _3iH-u">
  <ul class="la6-S ehTVt _96aZR PUdBR _3iH-u" aria-label="Wattpad links">
    <li><a class="u5f7- sB6J0 _58Jsq" href="">Wattpad Originals</a></li>
    <li><a class="u5f7- sB6J0 _58Jsq" href="">Try Premium</a></li>
    <li><a class="u5f7- sB6J0 _58Jsq" href="">Get the App</a></li>
    <li><button class="u5f7- sB6J0 _58Jsq">Language</button></li>
    <li><a class="u5f7- sB6J0 _58Jsq" href="">Writers</a></li>
    <li class="HAG5T">|</li>
    <li><a class="u5f7- sB6J0 _58Jsq" href="">Brand Partnerships</a></li>
    <li><a class="u5f7- sB6J0 _58Jsq" href="">Jobs</a></li>
    <li><a class="u5f7- sB6J0 _58Jsq" href="">Press</a></li>
  </ul>
  <ul class="VT-tn ehTVt _96aZR PUdBR _3iH-u" aria-label="Legal links">
    <li><a class="_7TWJ4 sB6J0 _58Jsq" href="" rel="nofollow">Terms</a></li>
    <li><a class="_7TWJ4 sB6J0 _58Jsq" href="" rel="nofollow">Privacy</a></li>
    <li><a class="_7TWJ4 sB6J0 _58Jsq" href="" rel="nofollow">Payment Policy</a></li>
    <li><a class="_7TWJ4 sB6J0 _58Jsq" href="" rel="nofollow">Accessibility</a></li>
    <li><a class="_7TWJ4 sB6J0 _58Jsq" href="">Help</a></li>
    <li class="uilPN">Â© 2025 Wattpad</li>
  </ul>
</footer>

<script>
  let currentParagraph = null;
  let paragraphCount = 1; // Keep track for initial setup
  let attachedImageFiles = new Map(); // Stores File objects, keyed by a unique ID
  let nextImageFileIndex = 0; // To generate unique names for file inputs

  // Generate unique IDs with timestamp to ensure uniqueness
  function generateUniqueId(type) {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 10000); // Increased random range
    return `${type}_${timestamp}_${random}`;
  }

  function handleKeyDown(event, textarea) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      showMediaPopup(textarea);
    }

    // Auto-resize textarea
    setTimeout(() => {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }, 0);
  }

  function showMediaPopup(textarea) {
    currentParagraph = textarea.parentElement;
    const popup = currentParagraph.querySelector('.add-media-popup');
    popup.classList.add('show');

    // Hide other popups
    document.querySelectorAll('.add-media-popup').forEach(p => {
      if (p !== popup) p.classList.remove('show');
    });
  }

  function hideMediaPopup() {
    document.querySelectorAll('.add-media-popup').forEach(p => {
      p.classList.remove('show');
    });
    addNewParagraph(); // Add a new paragraph automatically after media selection/popup close
  }

  function addMediaToCurrentParagraph(type) {
    hideAllPopups(); // Hide all popups first

    if (type === 'image') {
      document.getElementById('masterImageInput').click(); // Trigger the master file input
    } else if (type === 'video') {
      const videoUrl = prompt('Enter YouTube video URL:');
      if (videoUrl) {
        const videoId = extractYouTubeId(videoUrl);
        if (videoId) {
          const mediaElementId = generateUniqueId('video_embed');
          const mediaDiv = document.createElement('div');
          mediaDiv.className = 'embedded-media';
          mediaDiv.setAttribute('data-media-type', 'video');
          // Store the original URL and extracted ID for backend processing
          mediaDiv.setAttribute('data-video-url', videoUrl);
          mediaDiv.setAttribute('data-video-id', videoId);
          mediaDiv.setAttribute('id', mediaElementId); // Unique ID for element

          mediaDiv.innerHTML = `
                        <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        <button class="media-remove-btn" onclick="removeMedia(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
          currentParagraph.appendChild(mediaDiv);
          localStorage.setItem("isSaved", "false");
          $('.saved-indicator').text('Unsaved');
          addNewParagraph(); // Add a new paragraph after adding video
        } else {
          alert('Please enter a valid YouTube URL (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ)');
          return;
        }
      }
    }
  }

  function handleMasterImageSelection(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const imageUniqueId = generateUniqueId('image_file'); // Unique ID for this specific image file
      attachedImageFiles.set(imageUniqueId, file); // Store the actual File object

      // Create preview
      const reader = new FileReader();
      reader.onload = function(e) {
        const mediaDiv = document.createElement('div');
        mediaDiv.className = 'embedded-media';
        mediaDiv.setAttribute('data-media-type', 'image');
        mediaDiv.setAttribute('data-image-unique-id', imageUniqueId); // Link to the stored file
        mediaDiv.setAttribute('id', generateUniqueId('image_embed')); // Unique ID for element

        mediaDiv.innerHTML = `
                    <img src="${e.target.result}" alt="Uploaded image">
                    <button class="media-remove-btn" onclick="removeMedia(this)">
                        <i class="fas fa-times"></i>
                    </button>
                `;
        currentParagraph.appendChild(mediaDiv);
        localStorage.setItem("isSaved", "false");
        $('.saved-indicator').text('Unsaved');
        addNewParagraph(); // Add a new paragraph after adding image
      };
      reader.readAsDataURL(file);
    } else if (file) {
      alert('Please select a valid image file (e.g., JPG, PNG, GIF).');
    }

    // Reset file input to allow selecting the same file again if needed
    event.target.value = '';
  }

  function removeMedia(button) {
    const mediaDiv = button.parentElement;
    const mediaType = mediaDiv.getAttribute('data-media-type');

    if (mediaType === 'image') {
      const imageUniqueId = mediaDiv.getAttribute('data-image-unique-id');
      if (imageUniqueId) {
        attachedImageFiles.delete(imageUniqueId); // Remove the file from our map
      }
    }
    mediaDiv.remove();
    localStorage.setItem("isSaved", "false");
    $('.saved-indicator').text('Unsaved');
    updateWordCount();
  }

  function addNewParagraph() {
    const editor = document.getElementById('contentEditor');
    const paragraphId = generateUniqueId('paragraph_container');
    const textareaId = generateUniqueId('textarea');
    const popupId = generateUniqueId('popup');

    const newParagraph = document.createElement('div');
    newParagraph.className = 'paragraph-container';
    newParagraph.setAttribute('id', paragraphId);
    newParagraph.setAttribute('data-paragraph-id', paragraphId);
    newParagraph.innerHTML = `
            <textarea class="paragraph-textarea" id="${textareaId}" placeholder="Type your text"
                      onkeydown="handleKeyDown(event, this)"
                      oninput="updateWordCount()"></textarea>
            <div class="add-media-popup" id="${popupId}">
                <div class="media-option" onclick="addMediaToCurrentParagraph('image')">
                    <i class="fas fa-image"></i>
                    <span>Add Image</span>
                </div>
                <div class="media-option" onclick="addMediaToCurrentParagraph('video')">
                    <i class="fas fa-video"></i>
                    <span>Add Video</span>
                </div>
                <div class="media-option" onclick="hideMediaPopup()">
                    <i class="fas fa-times"></i>
                    <span>Continue Writing</span>
                </div>
            </div>
        `;
    editor.appendChild(newParagraph);
    localStorage.setItem("isSaved", "false");
    $('.saved-indicator').text('Unsaved');

    // Focus on new textarea after it's added to DOM
    const newTextarea = newParagraph.querySelector('.paragraph-textarea');
    newTextarea.focus();

    paragraphCount++;
  }

  function hideAllPopups() {
    document.querySelectorAll('.add-media-popup').forEach(p => {
      p.classList.remove('show');
    });
  }

  function extractYouTubeId(url) {
    // Updated regex to correctly extract YouTube IDs from various URLs
    const regExp = /(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=|embed\/|v\/|)([\w-]{11})(?:\S+)?/;
    const match = url.match(regExp);
    return (match && match[1].length === 11) ? match[1] : null;
  }

  function insertMedia(type) {
    // For top buttons, add media at the end of the last paragraph
    const editor = document.getElementById('contentEditor');
    const lastParagraph = editor.querySelector('.paragraph-container:last-child');
    currentParagraph = lastParagraph;
    addMediaToCurrentParagraph(type);
  }

  function updateWordCount() {
    const textareas = document.querySelectorAll('.paragraph-textarea');
    let totalWords = 0;

    textareas.forEach(textarea => {
      const text = textarea.value.trim();
      if (text) {
        totalWords += text.split(/\s+/).length;
      }
    });

    document.getElementById('wordCount').textContent = totalWords;
    document.getElementById('wordCountDisplay').textContent = totalWords + ' words';

    localStorage.setItem("isSaved", "false");
    $('.saved-indicator').text('unsaved');
  }


  // Function to submit the form based on action (publish/save)
  function submitForm(action) {
    document.getElementById('actionTypeInput').value = action; // Set the action type
    collectAndPrepareContentForForm(); // Prepare all content
    document.getElementById('chapterForm').submit(); // Submit the form
  }


  // Auto-save functionality (still uses fetch because it's background)
  setInterval(async () => {
    const storyId = document.querySelector('input[name="storyId"]')?.value;
    if (!storyId) return; // Don't auto-save if no storyId

    const chapterTitle = document.getElementById('chapterTitleEdit').textContent.trim();
    const editor = document.getElementById('contentEditor');
    const contentStructureForAutoSave = {
      paragraphs: []
    };

    editor.querySelectorAll('.paragraph-container').forEach((container) => {
      const textarea = container.querySelector('.paragraph-textarea');
      const media = container.querySelector('.embedded-media');

      const paragraphData = {
        type: 'text',
        value: textarea.value.trim(),
        media: null
      };

      if (media) {
        const mediaType = media.getAttribute('data-media-type');
        if (mediaType === 'image') {
          // For auto-save, we can't send the file directly with a simple JSON
          // You might save a reference to a temporary URL or just skip file data for auto-save
          // Or, if your auto-save endpoint is multipart, you'd need similar logic to collectAndPrepareContentForForm
          // For now, let's just indicate there's an image
          const imgSrc = media.querySelector('img')?.src;
          paragraphData.media = { type: 'image', url: imgSrc }; // Store base64 or temporary URL if available
        } else if (mediaType === 'video') {
          const videoUrl = media.getAttribute('data-video-url');
          const videoId = media.getAttribute('data-video-id');
          paragraphData.media = { type: 'video', url: videoUrl, videoId: videoId };
        }
      }
      contentStructureForAutoSave.paragraphs.push(paragraphData);
    });

    const autoSaveFormData = new FormData();
    autoSaveFormData.append('storyId', storyId);
    autoSaveFormData.append('chapterTitle', chapterTitle);
    autoSaveFormData.append('chapterContentJson', JSON.stringify(contentStructureForAutoSave));

    try {
      const response = await fetch('/chapters/autosave', {
        method: 'POST',
        body: autoSaveFormData
      });
      if (response.ok) {
        console.log('Chapter auto-saved successfully!');
        document.querySelector('.saved-indicator').textContent = 'Saved';
        setTimeout(() => {
          document.querySelector('.saved-indicator').textContent = 'Draft';
        }, 3000); // Briefly show "Saved"
      } else {
        console.error('Auto-save failed:', response.statusText);
      }
    } catch (error) {
      console.error('Auto-save error:', error);
    }
  }, 30000); // Auto-save every 30 seconds


  // Hide popups when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.add-media-popup') && !event.target.closest('.paragraph-textarea')) {
      hideAllPopups();
    }
  });

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    updateWordCount();

    // Focus on first textarea
    const firstTextarea = document.querySelector('.paragraph-textarea');
    if (firstTextarea) {
      firstTextarea.focus();
      // Adjust its height on load
      firstTextarea.style.height = 'auto';
      firstTextarea.style.height = firstTextarea.scrollHeight + 'px';
    }
  });
</script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="lib/jquery-3.7.1.min.js"></script>
<script src="assets/js/create-chapter-page-script.js"></script>
</body>
</html>